<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis - Video KYC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">V</div>
                <div class="logo-text">
                    <div class="logo-title">Video KYC</div>
                    <div class="logo-subtitle">AI Verification</div>
                </div>
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Home</a>
                <a href="/recording-assistant" class="nav-link">Recording Assistant</a>
                <a href="/upload" class="nav-link">Upload</a>
                <a href="/analyze" class="nav-link active">Analysis</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">AI Analysis</h1>
            <p class="page-subtitle">Select a video and configure settings to run comprehensive KYC analysis.</p>
        </div>

        <!-- Stepper -->
        <div class="stepper">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-line"></div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-line"></div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-line"></div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="step-content">
            <!-- Step 1: Select Video -->
            <div class="step-panel active" id="step-1">
                <div class="step-card">
                    <div class="step-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <h2>Step 1: Select Video</h2>
                    </div>
                    <p class="step-description">Choose a video from your uploads to analyze.</p>

                    <div class="video-grid" id="video-list">
                        <p class="loading-text">Loading videos...</p>
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="btn-secondary" disabled>Previous</button>
                    <button class="btn-primary" id="next-step-1" disabled>Next</button>
                </div>
            </div>

            <!-- Step 2: Select Reference Image -->
            <div class="step-panel" id="step-2">
                <div class="step-card">
                    <div class="step-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <h2>Step 2: Select Reference Image (Optional)</h2>
                    </div>
                    <p class="step-description">Choose a reference image for facial verification. This step is optional.</p>

                    <div class="image-grid" id="document-list">
                        <p class="loading-text">Loading documents...</p>
                    </div>

                    <p class="note-text">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        No reference image selected? Analysis will still check for document faces shown in video.
                    </p>
                </div>

                <div class="step-navigation">
                    <button class="btn-secondary" id="prev-step-2">Previous</button>
                    <button class="btn-primary" id="next-step-2">Next</button>
                </div>
            </div>

            <!-- Step 3: Configure Settings -->
            <div class="step-panel" id="step-3">
                <div class="step-card">
                    <div class="step-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                        </svg>
                        <h2>Step 3: Configure Settings</h2>
                    </div>
                    <p class="step-description">Select the Whisper model for audio transcription.</p>

                    <div class="settings-options">
                        <div class="radio-option" data-value="tiny">
                            <input type="radio" name="whisper-model" value="tiny" id="model-tiny">
                            <label for="model-tiny">
                                <div class="option-header">
                                    <span class="option-title">Tiny</span>
                                </div>
                                <p class="option-description">Fastest, lower accuracy</p>
                            </label>
                        </div>

                        <div class="radio-option" data-value="base">
                            <input type="radio" name="whisper-model" value="base" id="model-base" checked>
                            <label for="model-base">
                                <div class="option-header">
                                    <span class="option-title">Base</span>
                                    <span class="badge-recommended">Recommended</span>
                                </div>
                                <p class="option-description">Good balance of speed and accuracy</p>
                            </label>
                        </div>

                        <div class="radio-option" data-value="small">
                            <input type="radio" name="whisper-model" value="small" id="model-small">
                            <label for="model-small">
                                <div class="option-header">
                                    <span class="option-title">Small</span>
                                </div>
                                <p class="option-description">Better accuracy, moderate speed</p>
                            </label>
                        </div>

                        <div class="radio-option" data-value="medium">
                            <input type="radio" name="whisper-model" value="medium" id="model-medium">
                            <label for="model-medium">
                                <div class="option-header">
                                    <span class="option-title">Medium</span>
                                </div>
                                <p class="option-description">High accuracy, slower</p>
                            </label>
                        </div>

                        <div class="radio-option" data-value="large">
                            <input type="radio" name="whisper-model" value="large" id="model-large">
                            <label for="model-large">
                                <div class="option-header">
                                    <span class="option-title">Large</span>
                                </div>
                                <p class="option-description">Best accuracy, slowest</p>
                            </label>
                        </div>
                    </div>

                    <div class="info-note">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Larger models provide better transcription accuracy but take longer to process. For most cases, "Base" provides the best balance.
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="btn-secondary" id="prev-step-3">Previous</button>
                    <button class="btn-primary" id="next-step-3">Review & Start</button>
                </div>
            </div>

            <!-- Step 4: Start Analysis -->
            <div class="step-panel" id="step-4">
                <div class="step-card">
                    <div class="step-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <h2>Step 4: Start Analysis</h2>
                    </div>

                    <!-- Ready State -->
                    <div class="analysis-ready" id="analysis-ready">
                        <div class="ready-icon">
                            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <h3>Ready to Analyze</h3>
                        <div class="analysis-summary">
                            <p><strong>Video:</strong> <span id="selected-video-name">-</span></p>
                            <p><strong>Model:</strong> <span id="selected-model">Base</span></p>
                        </div>
                        <button class="btn-start-analysis" id="start-analysis-btn">Start Analysis</button>
                    </div>

                    <!-- Progress State -->
                    <div class="analysis-progress" id="analysis-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysis-progress-fill" style="width: 0%;">
                                <span id="analysis-progress-text">0%</span>
                            </div>
                        </div>
                        <p class="progress-status" id="progress-status">Initializing analysis...</p>
                        <div class="progress-badge">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            Analysis in Progress...
                        </div>
                    </div>
                </div>

                <div class="step-navigation">
                    <button class="btn-secondary" id="prev-step-4">Previous</button>
                    <button class="btn-secondary" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Video KYC. RBI-compliant verification system.</p>
            <div class="footer-badges">
                <span>Enterprise Grade Security</span>
                <span>â€¢</span>
                <span>ISO 27001 Certified</span>
            </div>
        </div>
    </footer>

    <script>
        let selectedVideo = null;
        let selectedDocument = null;
        let analysisId = null;
        let currentStep = 1;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVideos();
            loadDocuments();
            setupNavigation();
        });

        async function loadVideos() {
            try {
                const response = await fetch('/api/list-videos');
                const videos = await response.json();
                const videoList = document.getElementById('video-list');

                if (videos.length === 0) {
                    videoList.innerHTML = '<p class="empty-state">No videos found. Please upload a video first.</p>';
                    return;
                }

                videoList.innerHTML = '';
                videos.forEach(video => {
                    const card = document.createElement('div');
                    card.className = 'video-item';
                    card.onclick = () => selectVideo(video.filename, card);
                    card.innerHTML = `
                        <div class="item-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <div class="item-info">
                            <h4>${video.filename}</h4>
                            <p>${video.size_mb} MB</p>
                            <small>${new Date(video.uploaded).toLocaleDateString()}</small>
                            ${video.has_metadata ? '<span class="badge-metadata">Has Metadata</span>' : ''}
                        </div>
                    `;
                    videoList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('video-list').innerHTML = '<p class="error-state">Error loading videos</p>';
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/list-documents');
                const documents = await response.json();
                const documentList = document.getElementById('document-list');

                if (documents.length === 0) {
                    documentList.innerHTML = '<p class="empty-state">No reference images found. You can skip this step.</p>';
                    return;
                }

                documentList.innerHTML = '';
                documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'image-item';
                    card.onclick = () => selectDocument(doc.filename, card);
                    card.innerHTML = `
                        <div class="image-placeholder">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <div class="item-info">
                            <h4>${doc.filename}</h4>
                            <p>${doc.size || '0 KB'}</p>
                        </div>
                    `;
                    documentList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function selectVideo(filename, element) {
            document.querySelectorAll('.video-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedVideo = filename;
            document.getElementById('next-step-1').disabled = false;
            document.getElementById('selected-video-name').textContent = filename;
        }

        function selectDocument(filename, element) {
            if (selectedDocument === filename) {
                element.classList.remove('selected');
                selectedDocument = null;
            } else {
                document.querySelectorAll('.image-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                selectedDocument = filename;
            }
        }

        function setupNavigation() {
            // Step 1 -> 2
            document.getElementById('next-step-1').onclick = () => goToStep(2);

            // Step 2 navigation
            document.getElementById('prev-step-2').onclick = () => goToStep(1);
            document.getElementById('next-step-2').onclick = () => goToStep(3);

            // Step 3 navigation
            document.getElementById('prev-step-3').onclick = () => goToStep(2);
            document.getElementById('next-step-3').onclick = () => {
                const selectedModel = document.querySelector('input[name="whisper-model"]:checked').value;
                document.getElementById('selected-model').textContent = selectedModel.charAt(0).toUpperCase() + selectedModel.slice(1);
                goToStep(4);
            };

            // Step 4 navigation
            document.getElementById('prev-step-4').onclick = () => goToStep(3);
            document.getElementById('start-analysis-btn').onclick = startAnalysis;
        }

        function goToStep(step) {
            // Update stepper
            document.querySelectorAll('.step').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if (idx + 1 < step) el.classList.add('completed');
                if (idx + 1 === step) el.classList.add('active');
            });

            // Update panels
            document.querySelectorAll('.step-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            currentStep = step;
        }

        async function startAnalysis() {
            if (!selectedVideo) {
                alert('Please select a video');
                return;
            }

            const whisperModel = document.querySelector('input[name="whisper-model"]:checked').value;

            // Show progress
            document.getElementById('analysis-ready').style.display = 'none';
            document.getElementById('analysis-progress').style.display = 'block';

            try {
                const response = await fetch('/api/analyze-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video_filename: selectedVideo,
                        reference_image: selectedDocument,
                        whisper_model: whisperModel
                    })
                });

                const result = await response.json();
                if (result.success) {
                    analysisId = result.analysis_id;
                    pollAnalysisStatus();
                } else {
                    alert('Error starting analysis: ' + result.error);
                }
            } catch (error) {
                alert('Error starting analysis: ' + error.message);
            }
        }

        async function pollAnalysisStatus() {
            if (!analysisId) return;

            try {
                const response = await fetch(`/api/analysis-status/${analysisId}`);
                const status = await response.json();

                const progress = status.progress || 0;
                const stage = status.stage || 'Processing...';

                document.getElementById('analysis-progress-fill').style.width = progress + '%';
                document.getElementById('analysis-progress-text').textContent = progress + '%';
                document.getElementById('progress-status').textContent = stage;

                if (status.status === 'completed') {
                    setTimeout(() => {
                        window.location.href = `/results/${analysisId}`;
                    }, 1000);
                } else if (status.status === 'error') {
                    alert('Analysis failed: ' + status.error);
                } else {
                    setTimeout(pollAnalysisStatus, 2000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                setTimeout(pollAnalysisStatus, 2000);
            }
        }
    </script>
</body>
</html>
