<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Video KYC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">V</div>
                <div class="logo-text">
                    <div class="logo-title">Video KYC</div>
                    <div class="logo-subtitle">AI Verification</div>
                </div>
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Home</a>
                <a href="/recording-assistant" class="nav-link">Recording Assistant</a>
                <a href="/upload" class="nav-link">Upload</a>
                <a href="/analyze" class="nav-link">Analysis</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="results-page">
        <!-- Decision Banner -->
        <div class="decision-banner" id="decision-banner">
            <div class="decision-icon" id="decision-icon"></div>
            <div class="decision-verdict" id="decision-verdict">PASS</div>
            <div class="decision-score" id="decision-score">
                <span class="score-value">87.5</span>
                <span class="score-total">/100</span>
            </div>
            <p class="decision-message" id="decision-message">
                All verification checks passed with high confidence. Customer identity confirmed.
            </p>
        </div>

        <!-- Module Scores -->
        <div class="results-section">
            <h2 class="section-title">Module Scores</h2>
            <div class="modules-scores-grid" id="modules-scores">
                <!-- Modules will be populated by JavaScript -->
            </div>
        </div>

        <!-- Key Findings -->
        <div class="results-section">
            <h2 class="section-title">Key Findings</h2>
            <div class="findings-list" id="key-findings">
                <!-- Findings will be populated by JavaScript -->
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="results-section">
            <h2 class="section-title">Detailed Analysis</h2>
            <div class="detailed-analysis" id="detailed-analysis">
                <!-- Detailed sections will be populated by JavaScript -->
            </div>
        </div>

        <!-- Analysis Metadata -->
        <div class="results-section">
            <h2 class="section-title">Analysis Metadata</h2>
            <div class="metadata-grid" id="metadata-grid">
                <!-- Metadata will be populated by JavaScript -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="results-actions">
            <button class="btn-action btn-primary" onclick="window.location.href='/analyze'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Analyze Another Video
            </button>
            <button class="btn-action btn-secondary" id="download-report-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Full Report
            </button>
            <button class="btn-action btn-secondary" onclick="window.location.href='/'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to Home
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Video KYC. RBI-compliant verification system.</p>
            <div class="footer-badges">
                <span>Enterprise Grade Security</span>
                <span>â€¢</span>
                <span>ISO 27001 Certified</span>
            </div>
        </div>
    </footer>

    <script>
        // Get analysis ID from URL
        const analysisId = window.location.pathname.split('/').pop();

        // Module configuration
        const moduleConfig = {
            'liveness_detection': { name: 'Liveness Detection', weight: 20, color: '#3B82F6' },
            'face_match': { name: 'Face Match', weight: 25, color: '#10B981' },
            'script_compliance': { name: 'Script Compliance', weight: 20, color: '#7C3AED' },
            'document_verification': { name: 'Document Verification', weight: 15, color: '#F59E0B' },
            'behavior_analysis': { name: 'Behavior Analysis', weight: 10, color: '#EF4444' },
            'consent_verification': { name: 'Consent Verification', weight: 10, color: '#06B6D4' }
        };

        // Load results data
        fetch(`/api/get-results/${analysisId}`)
            .then(response => response.json())
            .then(data => {
                renderResults(data);
            })
            .catch(error => {
                console.error('Error loading results:', error);
                document.querySelector('.results-page').innerHTML = '<div class="error-message">Error loading results</div>';
            });

        function renderResults(data) {
            // Render decision banner
            renderDecisionBanner(data);

            // Render module scores
            renderModuleScores(data);

            // Render key findings
            renderKeyFindings(data);

            // Render detailed analysis
            renderDetailedAnalysis(data);

            // Render metadata
            renderMetadata(data);
        }

        function renderDecisionBanner(data) {
            const banner = document.getElementById('decision-banner');
            const icon = document.getElementById('decision-icon');
            const verdict = document.getElementById('decision-verdict');
            const score = document.getElementById('decision-score');
            const message = document.getElementById('decision-message');

            const finalScore = data.final_score || 0;
            const decision = data.final_decision || 'PASS';

            // Set banner class
            banner.className = 'decision-banner decision-' + decision.toLowerCase();

            // Set icon
            if (decision === 'PASS') {
                icon.innerHTML = `<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>`;
            } else if (decision === 'FLAG') {
                icon.innerHTML = `<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>`;
            } else {
                icon.innerHTML = `<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>`;
            }

            // Set verdict and score
            verdict.textContent = decision;
            score.querySelector('.score-value').textContent = finalScore.toFixed(1);

            // Set message
            message.textContent = data.decision_reason || '';
        }

        function renderModuleScores(data) {
            const container = document.getElementById('modules-scores');
            const modules = data.module_scores || {};

            container.innerHTML = '';

            Object.keys(moduleConfig).forEach(moduleKey => {
                const config = moduleConfig[moduleKey];
                const moduleData = modules[moduleKey] || { score: 0, points_contribution: 0 };
                const score = moduleData.score || 0;
                const points = moduleData.points_contribution || 0;

                const card = document.createElement('div');
                card.className = 'module-score-card';
                card.innerHTML = `
                    <div class="module-score-header">
                        <h3>${config.name}</h3>
                        <div class="module-score-value">${Math.round(score)}</div>
                    </div>
                    <div class="module-score-weight">Weight: ${config.weight}%</div>
                    <div class="module-score-bar">
                        <div class="module-score-fill" style="width: ${score}%; background: ${getScoreColor(score)}"></div>
                    </div>
                    <div class="module-score-points">${points > 0 ? '+' : ''}${points.toFixed(1)} points</div>
                `;
                container.appendChild(card);
            });
        }

        function renderKeyFindings(data) {
            const container = document.getElementById('key-findings');
            const findings = [];

            // Collect findings from all modules
            const modules = data.module_scores || {};
            Object.keys(modules).forEach(moduleKey => {
                const moduleData = modules[moduleKey];
                if (moduleData.key_findings) {
                    findings.push(...moduleData.key_findings);
                }
            });

            container.innerHTML = '';

            if (findings.length === 0) {
                container.innerHTML = '<p class="no-findings">No specific findings to report.</p>';
                return;
            }

            findings.forEach(finding => {
                const item = document.createElement('div');
                item.className = 'finding-item finding-' + (finding.severity || 'info');
                item.innerHTML = `
                    <div class="finding-icon">
                        ${finding.severity === 'pass' || finding.severity === 'success' ?
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>' :
                            finding.severity === 'warning' || finding.severity === 'flag' ?
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path></svg>' :
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
                        }
                    </div>
                    <p>${finding.message || finding}</p>
                `;
                container.appendChild(item);
            });
        }

        function renderDetailedAnalysis(data) {
            const container = document.getElementById('detailed-analysis');
            const modules = data.module_scores || {};

            container.innerHTML = '';

            Object.keys(moduleConfig).forEach(moduleKey => {
                const config = moduleConfig[moduleKey];
                const moduleData = modules[moduleKey] || {};
                const score = moduleData.score || 0;

                const accordion = document.createElement('div');
                accordion.className = 'analysis-accordion';

                const header = document.createElement('div');
                header.className = 'accordion-header';
                header.innerHTML = `
                    <h3>${config.name}</h3>
                    <div class="accordion-score" style="color: ${getScoreColor(score)}">${Math.round(score)}/100</div>
                    <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                content.innerHTML = `
                    <div class="accordion-details">
                        ${moduleData.details ? formatDetails(moduleData.details) : '<p>No detailed information available.</p>'}
                    </div>
                `;

                header.onclick = () => {
                    accordion.classList.toggle('active');
                };

                accordion.appendChild(header);
                accordion.appendChild(content);
                container.appendChild(accordion);
            });
        }

        function renderMetadata(data) {
            const container = document.getElementById('metadata-grid');
            const metadata = data.metadata || {};

            container.innerHTML = `
                <div class="metadata-item">
                    <div class="metadata-label">Analysis Id</div>
                    <div class="metadata-value">${analysisId || '-'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Video File</div>
                    <div class="metadata-value">${metadata.video_filename || data.video_filename || '-'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Duration</div>
                    <div class="metadata-value">${metadata.duration || data.duration || '-'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Resolution</div>
                    <div class="metadata-value">${metadata.resolution || data.resolution || '-'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Timestamp</div>
                    <div class="metadata-value">${metadata.timestamp || data.timestamp || new Date().toLocaleString()}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Report Id</div>
                    <div class="metadata-value">${metadata.report_id || 'RPT-' + Date.now()}</div>
                </div>
            `;
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10B981';
            if (score >= 60) return '#F59E0B';
            return '#EF4444';
        }

        function formatDetails(details) {
            if (typeof details === 'string') {
                return `<p>${details}</p>`;
            }

            if (typeof details === 'object') {
                let html = '<div class="details-list">';
                Object.keys(details).forEach(key => {
                    html += `<div class="detail-row">
                        <span class="detail-key">${formatKey(key)}:</span>
                        <span class="detail-value">${formatValue(details[key])}</span>
                    </div>`;
                });
                html += '</div>';
                return html;
            }

            return '<p>No details available.</p>';
        }

        function formatKey(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatValue(value) {
            if (typeof value === 'boolean') return value ? 'Yes' : 'No';
            if (typeof value === 'number') return value.toFixed(2);
            if (Array.isArray(value)) return value.join(', ');
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            return value;
        }

        // Download report functionality
        document.getElementById('download-report-btn').addEventListener('click', () => {
            window.location.href = `/api/download-report/${analysisId}`;
        });
    </script>
</body>
</html>
